<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Player - {{ query }}</title>

    <style>
        :root {
            --bg-base: #030303;
            --bg-surface: #121212;
            --bg-elevated: #1a1a1a;
            --primary: #ff0000;
            --text-main: #ffffff;
            --text-dim: #909090;
            --text-muted: #606060;
            --border: rgba(255, 255, 255, 0.08);
            --radius-sm: 4px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-full: 999px;
            --font-main: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        body {
            font-family: var(--font-main);
            background: var(--bg-base);
            color: var(--text-main);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            padding-bottom: 160px;
        }

        /* --- Header --- */
        .header {
            background: rgba(3, 3, 3, 0.9);
            backdrop-filter: blur(20px);
            padding: 5px 16px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0;
        }

        .header-logo {
            font-size: 1.2em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-logo svg {
            color: var(--primary);
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-main);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- Search & Toggles --- */
        .search-section {
            padding: 0 16px;
            margin-top: 3px;
        }

        #trackForm {
            margin: 0;
        }

        .search-box {
            position: relative;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .search-box.visible {
            max-height: 100px;
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 18px;
            padding-right: 90px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 15px;
            background: var(--bg-surface);
            color: #fff;
            outline: none;
        }

        .search-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
        }

        .clear-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 16px;
        }

        .search-button {
            background: none;
            border: none;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }

        /* Navigation Pill Style as per Image */
        .nav-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding: 0 4px;
        }

        .type-toggle-pill {
            display: flex;
            background: #1a1a1a;
            border-radius: var(--radius-lg);
            padding: 4px;
            gap: 4px;
        }

        .type-option {
            padding: 10px 24px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.2s;
            color: #fff;
        }

        .type-option.active {
            background: #fff;
            color: #000;
        }

        .sort-pill {
            background: #1a1a1a;
            padding: 8px 16px;
            border-radius: var(--radius-lg);
            color: var(--text-dim);
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            border: none;
        }

        .refresh-icon {
            transition: transform 0.3s;
        }

        body.searching .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Results Meta */
        .results-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 16px 16px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .results-line {
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* --- Track Item Layout (Matches Image) --- */
        .tracks-list {
            padding: 0;
        }

        .track-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            transition: background 0.2s;
            gap: 16px;
            cursor: pointer;
        }

        .track-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .track-index {
            color: var(--text-muted);
            font-size: 14px;
            min-width: 24px;
            text-align: center;
        }

        .track-thumb-box {
            width: 56px;
            height: 56px;
            min-width: 56px;
            position: relative;
        }

        .track-thumbnail {
            width: 100%;
            height: 100%;
            border-radius: 4px;
            object-fit: cover;
        }

        .track-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .track-title {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-artist-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-dim);
        }

        .badge {
            font-size: 10px;
            font-weight: 600;
            padding: 1px 6px;
            border-radius: 2px;
            text-transform: capitalize;
            background: rgba(255, 255, 255, 0.1);
        }

        .badge-official {
            color: #2ba640;
            background: rgba(43, 166, 64, 0.1);
        }

        .badge-remix {
            color: #3973fa;
            background: rgba(57, 115, 250, 0.1);
        }

        .badge-dance {
            color: #f9bf3b;
            background: rgba(249, 191, 59, 0.1);
        }

        .badge-slowed {
            color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        .menu-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 8px;
            cursor: pointer;
        }

        /* --- Mini Player --- */
        .volume-player {
            position: fixed;
            bottom: 74px;
            left: 0;
            right: 0;
            background: #111;
            padding: 16px;
            display: none;
            flex-direction: column;
            gap: 12px;
            border-top: 1px solid var(--border);
            z-index: 1001;
        }

        .player-content-top {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .player-info-box {
            flex: 1;
            min-width: 0;
        }

        .player-title {
            font-size: 15px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-artist {
            font-size: 13px;
            color: var(--text-dim);
        }

        .player-controls-right {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #fff;
        }

        .control-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 4px;
        }

        /* Progress Bar Styling */
        .seek-container {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
            color: var(--text-dim);
            font-family: monospace;
        }

        .seek-bar-wrapper {
            flex: 1;
            height: 3px;
            background: #333;
            position: relative;
            border-radius: 2px;
        }

        .seek-progress {
            position: absolute;
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            width: 30%;
        }

        .seek-knob {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
        }

        .volume-slider-hidden {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            display: flex;
            justify-content: space-around;
            padding: 12px 0 32px;
            border-top: 1px solid var(--border);
            z-index: 1002;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 11px;
            gap: 4px;
        }

        .nav-item.active {
            color: #fff;
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .volume-player.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        /* --- Volume Popover --- */
        .volume-popover {
            position: fixed;
            bottom: 90px;
            right: 12px;
            background: rgba(18, 18, 18, 0.98);
            backdrop-filter: blur(25px);
            padding: 30px 12px 18px;
            border-radius: 40px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1003;
            height: 280px;
            animation: slideUp 0.2s ease-out;
            touch-action: none;
        }

        .volume-popover.active {
            display: flex;
        }

        .vert-slider-wrapper {
            flex: 1;
            width: 8px;
            background: #2a2a2a;
            position: relative;
            border-radius: 4px;
            touch-action: none;
            overflow: visible;
            /* Ensure knob doesn't clip */
        }

        .vert-progress {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: height 0.1s linear;
        }

        .vert-knob {
            position: absolute;
            left: 50%;
            top: 0;
            transform: translate(-50%, -50%);
            width: 26px;
            height: 26px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
            z-index: 2;
        }

        .vert-slider-hidden {
            position: absolute;
            width: 100px;
            /* Massive hit area */
            height: 100%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            cursor: pointer;
            z-index: 10;
            touch-action: none;
            /* Explicitly ensuring visibility for interactivity if browser needs it */
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.01);
        }

        @media (max-width: 480px) {
            .volume-popover {
                right: 8px;
                bottom: 84px;
            }
        }

        /* --- QR Modal --- */
        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .qr-modal.active {
            display: flex;
        }

        .qr-content {
            background: var(--bg-surface);
            padding: 32px;
            border-radius: var(--radius-lg);
            text-align: center;
            border: 1px solid var(--border);
        }

        .qr-content img {
            width: 220px;
            height: 220px;
            margin: 20px 0;
            border-radius: var(--radius-md);
        }

        .qr-url {
            color: var(--text-dim);
            font-size: 11px;
        }

        /* --- Global Loading Bar --- */
        body.searching::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            background-size: 200% 100%;
            animation: loadingBar 1.5s infinite;
            z-index: 9999;
        }

        @keyframes loadingBar {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="header-logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z" />
                    </svg>
                    <span>Premium DJ</span>
                </div>
                <div class="header-right">
                    <button class="icon-btn" onclick="toggleQR(event)" title="Share Control">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M4,4H10V10H4V4M20,4V10H14V4H20M14,15H16V13H14V15M16,17H18V15H16V17M18,15H20V13H18V15M19,19H21V17H19V19M17,19H19V17H17V19M15,19H17V17H15V19M14,21H16V19H14V21M18,21H20V19H18V21M20,21H22V19H20V21M4,14H10V20H4V14M6,6V8H8V6H6M16,6V8H18V6H16M6,16V18H8V16H6M14,20H16V18H14V20Z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Search -->
        <section class="search-section">
            <form id="trackForm" action="/recommendations/" method="POST">
                <input type="radio" style="display: none;" id="nextPlay" name="nextPlay">
                <input type="range" style="display: none;" id="maxVol" name="maxVol" min="0" max="100"
                    value="{{maxVol}}">
                <input type="hidden" id="musicTypeInput" name="music_type" value="{{ music_type }}">
                <input type="hidden" name="videoId" id="videoIdInput">
                <input type="hidden" name="limit" value="{{recLimit}}">

                <div class="search-box" id="searchBox">
                    <input type="text" name="query" id="queryInput" class="search-input"
                        placeholder="What do you want to play?" value="{{ query }}" autocomplete="off">
                    <div class="search-actions">
                        <button type="button" class="clear-btn" id="clearSearch">âœ•</button>
                        <button type="submit" class="search-button">Search</button>
                    </div>
                </div>

                <div class="nav-row">
                    <div class="type-toggle-pill">
                        <div class="type-option {% if music_type == 'songs' or not music_type %}active{% endif %}"
                            onclick="setType('songs')">Songs</div>
                        <div class="type-option {% if music_type == 'videos' %}active{% endif %}"
                            onclick="setType('videos')">Videos</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="sort-pill" id="refreshBtn" onclick="submitSearch(null, true)"
                            title="Refresh Recommendations">
                            <svg class="refresh-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" />
                            </svg>
                            <span>Refresh</span>
                        </button>
                        <button type="button" class="sort-pill" onclick="cycleSort()">
                            <span id="sortLabel">Sort ></span>
                        </button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Stats -->
        <div class="results-meta">
            <span>{{ song_tracks|length if music_type == 'songs' else video_tracks|length }} results â€¢ {{
                song_tracks|length if music_type == 'songs' else video_tracks|length }} results</span>
            <div class="results-line"></div>
        </div>

        <!-- Tracks List -->
        <main class="tracks-list" id="tracksList">
            <div id="songsContainer"
                style="display: {% if music_type == 'songs' or not music_type %}block{% else %}none{% endif %};">
                {% if song_tracks %}
                {% for t in song_tracks %}
                <div class="track-item" data-title="{{ t.title }}" data-videoid="{{ t.videoId }}"
                    data-thumb="{{ t.thumbnail }}" data-artist="{{ t.artist }}">
                    <div class="track-index">{{ loop.index }}</div>
                    <div class="track-thumb-box">
                        <img src="{{ t.thumbnail }}" alt="{{ t.title }}" class="track-thumbnail"
                            onerror="handleImageError(this, '{{ t.videoId }}')">
                    </div>
                    <div class="track-info">
                        <div class="track-title">{{ t.title }}</div>
                        <div class="track-artist-row">
                            <span>{{ t.artist }}</span>
                            {% if t.labels %}
                            {% for label in t.labels %}
                            <span
                                class="badge {% if label == 'Official' %}badge-official{% elif label == 'Remix' %}badge-remix{% elif label == 'Dance' %}badge-dance{% elif label == 'Slowed' %}badge-slowed{% endif %}">{{
                                label }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    <button class="menu-btn" onclick="event.stopPropagation()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z" />
                        </svg>
                    </button>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-muted);">
                    <p>No songs found</p>
                </div>
                {% endif %}
            </div>

            <div id="videosContainer" style="display: {% if music_type == 'videos' %}block{% else %}none{% endif %};">
                {% if video_tracks %}
                {% for t in video_tracks %}
                <div class="track-item" data-title="{{ t.title }}" data-videoid="{{ t.videoId }}"
                    data-thumb="{{ t.thumbnail }}" data-artist="{{ t.artist }}">
                    <div class="track-index">{{ loop.index }}</div>
                    <div class="track-thumb-box">
                        <img src="{{ t.thumbnail }}" alt="{{ t.title }}" class="track-thumbnail"
                            onerror="handleImageError(this, '{{ t.videoId }}')">
                    </div>
                    <div class="track-info">
                        <div class="track-title">{{ t.title }}</div>
                        <div class="track-artist-row">
                            <span>{{ t.artist }}</span>
                            {% if t.labels %}
                            {% for label in t.labels %}
                            <span
                                class="badge {% if label == 'Official' %}badge-official{% elif label == 'Remix' %}badge-remix{% elif label == 'Dance' %}badge-dance{% endif %}">{{
                                label }}</span>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    <button class="menu-btn" onclick="event.stopPropagation()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z" />
                        </svg>
                    </button>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-muted);">
                    <p>No videos found</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Mini Player -->
    <div class="volume-player" id="miniPlayer">
        <div class="player-content-top">
            <div class="player-info-box">
                <div class="player-title" id="nowPlayingTitle">Not Playing</div>
                <div class="player-artist" id="nowPlayingArtist">Select a track</div>
            </div>
            <div class="player-controls-right">
                <button class="control-btn" id="prevBtn" onclick="sendPlayerControl('prev')"><svg width="24" height="24"
                        viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" />
                    </svg></button>
                <button class="control-btn" id="playPauseBtn" onclick="sendPlayerControl('toggle')"><svg width="28"
                        height="28" viewBox="0 0 24 24" fill="currentColor">
                        <path id="playPausePath" d="M8 5v14l11-7z" />
                    </svg></button>
                <button class="control-btn" id="nextBtn" onclick="sendPlayerControl('next')"><svg width="24" height="24"
                        viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                    </svg></button>
            </div>
        </div>
        <div class="seek-container">
            <span>1:27</span>
            <div class="seek-bar-wrapper">
                <div class="seek-progress" id="volProgress" style="width: {{maxVol}}%;">
                    <div class="seek-knob"></div>
                </div>
                <input type="range" class="volume-slider-hidden" id="volumeSlider" min="0" max="100" value="{{maxVol}}">
            </div>
            <span>-2:48</span>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <a href="/" class="nav-item active">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" />
            </svg>
            <span>Home</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="toggleSearch()">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" />
            </svg>
            <span>Explore</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="toggleVolumePopover(event)">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16.02C15.5,15.29 16.5,13.77 16.5,12M3,9V15H7L12,20V4L7,9H3Z" />
            </svg>
            <span>Volume</span>
        </a>
    </nav>

    <!-- Volume Popover -->
    <div class="volume-popover" id="navVolumePopover" onclick="event.stopPropagation()">
        <div class="vert-slider-wrapper">
            <div class="vert-progress" id="navVolProgress" style="height: {{maxVol}}%;">
                <div class="vert-knob"></div>
            </div>
            <input type="range" class="vert-slider-hidden" id="navVolSlider" min="0" max="100" value="{{maxVol}}">
        </div>
        <span style="font-size: 13px; font-weight: 800; color: #fff; font-family: 'Inter', sans-serif;"
            id="navVolLabel">{{maxVol}}%</span>
    </div>
    <!-- QR Modal -->
    <div class="qr-modal" id="qrModal" onclick="hideQR()">
        <div class="qr-content" onclick="event.stopPropagation()">
            <h3>ðŸ“± Scan to Control</h3>
            <img id="qrImage" src="" alt="QR">
            <div class="qr-url" id="qrUrl"></div>
        </div>
    </div>


    <script>
        function handleImageError(img, videoId) {
            const fallbacks = [`https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`, `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`];
            let currentIdx = fallbacks.indexOf(img.src);
            if (currentIdx < fallbacks.length - 1) img.src = fallbacks[currentIdx + 1];
            else img.onerror = null;
        }

        const queryInput = document.getElementById('queryInput');
        const clearBtn = document.getElementById('clearSearch');
        function toggleClearBtn() { clearBtn.style.display = queryInput.value.length > 0 ? 'block' : 'none'; }
        queryInput.addEventListener('input', toggleClearBtn);
        clearBtn.addEventListener('click', () => { queryInput.value = ''; toggleClearBtn(); queryInput.focus(); });
        toggleClearBtn();

        const searchBox = document.getElementById('searchBox');
        let searchHideTimer = null;

        function resetSearchTimer() {
            if (searchHideTimer) clearTimeout(searchHideTimer);
            searchHideTimer = setTimeout(() => {
                if (document.activeElement !== queryInput) {
                    searchBox.classList.remove('visible');
                } else {
                    // If still focused, try again in 3s
                    resetSearchTimer();
                }
            }, 3000);
        }

        queryInput.addEventListener('input', () => {
            toggleClearBtn();
            resetSearchTimer();
        });
        queryInput.addEventListener('focus', resetSearchTimer);
        searchBox.addEventListener('mousedown', resetSearchTimer);
        searchBox.addEventListener('touchstart', resetSearchTimer);

        function toggleSearch() {
            searchBox.classList.toggle('visible');
            if (searchBox.classList.contains('visible')) {
                queryInput.focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
                resetSearchTimer();
            }
        }

        async function submitSearch(e, isRefresh = false) {
            if (e) e.preventDefault();
            const form = document.getElementById('trackForm');
            const formData = new FormData(form);
            if (isRefresh) {
                formData.append('refresh', 'true');
            }
            document.body.classList.add('searching');

            try {
                const response = await fetch('/recommendations/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                });
                if (!response.ok) throw new Error('Search failed');
                const data = await response.json();

                if (data.query) queryInput.value = data.query;

                const render = (t, i) => `
                    <div class="track-item" data-title="${t.title}" data-videoid="${t.videoId}" data-thumb="${t.thumbnail}" data-artist="${t.artist}">
                        <div class="track-index">${i}</div>
                        <div class="track-thumb-box">
                            <img src="${t.thumbnail}" alt="${t.title}" class="track-thumbnail" onerror="handleImageError(this, '${t.videoId}')">
                        </div>
                        <div class="track-info">
                            <div class="track-title">${t.title}</div>
                            <div class="track-artist-row">
                                <span>${t.artist}</span>
                                ${(t.labels || []).map(l => `<span class="badge ${l === 'Official' ? 'badge-official' : l === 'Remix' ? 'badge-remix' : l === 'Dance' ? 'badge-dance' : l === 'Slowed' ? 'badge-slowed' : ''}">${l}</span>`).join('')}
                            </div>
                        </div>
                        <button class="menu-btn" onclick="event.stopPropagation()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 16c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z" /></svg>
                        </button>
                    </div>`;

                const sCont = document.getElementById('songsContainer');
                const vCont = document.getElementById('videosContainer');

                sCont.innerHTML = data.song_tracks.length ? data.song_tracks.map((t, i) => render(t, i + 1)).join('') : '<div class="empty-state" style="padding:40px;text-align:center;color:var(--text-muted);"><p>No songs found</p></div>';
                vCont.innerHTML = data.video_tracks.length ? data.video_tracks.map((t, i) => render(t, i + 1)).join('') : '<div class="empty-state" style="padding:40px;text-align:center;color:var(--text-muted);"><p>No videos found</p></div>';

                setType(data.music_type || 'songs');
                sessionStorage.setItem('searchPerformed', 'true');
                resetSearchTimer();

                document.getElementById('nextPlay').checked = false;
            } catch (err) {
                console.error(err);
            } finally {
                document.body.classList.remove('searching');
            }
        }

        document.getElementById('trackForm').addEventListener('submit', submitSearch);

        window.addEventListener('load', () => {
            if (sessionStorage.getItem('searchPerformed') === 'true') {
                searchBox.classList.add('visible');
                sessionStorage.removeItem('searchPerformed');
                resetSearchTimer();
            }
        });

        function setType(type) {
            document.getElementById('musicTypeInput').value = type;
            document.querySelectorAll('.type-option').forEach(opt => {
                opt.classList.toggle('active', opt.textContent.trim().toLowerCase() === type);
            });
            document.getElementById('songsContainer').style.display = type === 'songs' ? 'block' : 'none';
            document.getElementById('videosContainer').style.display = type === 'videos' ? 'block' : 'none';
            // Update stats
            const count = document.getElementById(type + 'Container').querySelectorAll('.track-item').length;
            document.querySelector('.results-meta span').textContent = `${count} results â€¢ ${count} results`;
        }




        /* ===================== Unified Sync Client ===================== */
        class DJSyncClient {
            constructor(role = 'controller') {
                this.role = role;
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectDelay = 30000;
                this.baseDelay = 3000;
                this.pingInterval = null;
                this.connect();
            }

            connect() {
                const isLocal = !window.location.hostname ||
                    window.location.hostname === "localhost" ||
                    window.location.hostname === "127.0.0.1" ||
                    window.location.hostname.startsWith("192.168.") ||
                    window.location.hostname.startsWith("10.") ||
                    window.location.hostname.startsWith("172.");

                // Ngrok Base URL
                const WBase = "wss://unappendaged-aretha-unwaning.ngrok-free.dev";

                let url;
                if (isLocal) {
                    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                    url = `${protocol}//${location.host}/ws/sync?role=${this.role}`;
                } else {
                    url = `${WBase}/ws/sync?role=${this.role}`;
                }

                console.log(`[Sync] Connecting to ${url}...`);
                this.ws = new WebSocket(url);

                this.ws.onopen = () => {
                    console.log("[Sync] âœ… Connected");
                    this.reconnectAttempts = 0;
                    this.startHeartbeat();
                    // If we're a controller, the first thing we might want is current state
                    // (But for now just being connected is enough)
                };

                this.ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        this.handleMessage(msg);
                    } catch (err) {
                        console.error("[Sync] Message parse error:", err);
                    }
                };

                this.ws.onclose = () => {
                    console.log("[Sync] ðŸ”Œ Disconnected");
                    this.stopHeartbeat();
                    this.retry();
                };

                this.ws.onerror = (err) => {
                    console.error("[Sync] âŒ Error:", err);
                };
            }

            startHeartbeat() {
                this.pingInterval = setInterval(() => {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.send('ping', { ts: Date.now() });
                    }
                }, 10000);
            }

            stopHeartbeat() {
                if (this.pingInterval) clearInterval(this.pingInterval);
            }

            retry() {
                const delay = Math.min(this.baseDelay * Math.pow(2, this.reconnectAttempts), this.maxReconnectDelay);
                console.log(`[Sync] Retrying in ${delay / 1000}s...`);
                setTimeout(() => {
                    this.reconnectAttempts++;
                    this.connect();
                }, delay);
            }

            send(type, data) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type, data }));
                } else {
                    console.warn(`[Sync] Cannot send ${type}, socket not open`);
                }
            }

            handleMessage(msg) {
                const { type, data } = msg;
                switch (type) {
                    case 'pong':
                        // Heartbeat reply
                        break;
                    case 'play':
                        if (data.videoId) {
                            document.getElementById('miniPlayer').classList.add('active');
                            if (data.title) document.getElementById('nowPlayingTitle').textContent = data.title;
                            isPlaying = true;
                            const path = document.getElementById('playPausePath');
                            if (path) path.setAttribute('d', 'M6 19h4V5H6v14zm8-14v14h4V5h-4z');
                        }
                        break;
                    case 'vol':
                        const v = parseInt(data.volume);
                        if (!isNaN(v)) syncVolumeUI(v);
                        break;
                    case 'control':
                        // If we just sent a command, ignore incoming state for 1.5s to avoid flickering
                        if (Date.now() - lastUserActionTime < 1500) return;

                        if (data.action === 'toggle' || data.action === 'stateChange') {
                            isPlaying = (data.state === 'playing');
                            const path = document.getElementById('playPausePath');
                            if (path) {
                                path.setAttribute('d', isPlaying ? 'M6 19h4V5H6v14zm8-14v14h4V5h-4z' : 'M8 5v14l11-7z');
                            }
                        }
                        break;
                    case 'qr':
                        if (data.img) {
                            document.getElementById('qrImage').src = `data:image/png;base64,${data.img.replace(/^"|"$/g, '')}`;
                            document.getElementById('qrUrl').textContent = data.url || window.location.origin;
                            qrModal.classList.add('active');
                        }
                        break;
                }
            }
        }

        // Initialize single sync client
        const syncClient = new DJSyncClient('controller');
        /* ===================== UI Elements ===================== */
        const volSlider = document.getElementById('volumeSlider');
        const volProgress = document.getElementById('volProgress');
        const navVolSlider = document.getElementById('navVolSlider');
        const navVolProgress = document.getElementById('navVolProgress');
        const navVolLabel = document.getElementById('navVolLabel');
        const qrModal = document.getElementById('qrModal');

        let isPlaying = false;
        let lastUserActionTime = 0;

        function toggleQR(e) {
            e.stopPropagation();
            if (qrModal.classList.contains('active')) return hideQR();
            syncClient.send('qr', { url: window.location.origin });
        }

        function hideQR() { qrModal.classList.remove('active'); }

        function sendPlayerControl(action) {
            lastUserActionTime = Date.now();
            if (action === 'next' || action === 'prev') {
                const results = Array.from(document.querySelectorAll('.track-item'));
                if (results.length > 0) {
                    const currentTitle = document.getElementById('nowPlayingTitle').textContent;
                    const currentIndex = results.findIndex(item => item.dataset.title === currentTitle);
                    let targetIndex = -1;

                    if (action === 'next') {
                        targetIndex = (currentIndex + 1) % results.length;
                    } else {
                        targetIndex = (currentIndex - 1 + results.length) % results.length;
                    }

                    if (targetIndex !== -1) {
                        const nextItem = results[targetIndex];
                        playTrackFromItem(nextItem);
                        return; // Done
                    }
                }
            }

            let msgData = { action: action, timestamp: Date.now() };
            if (action === 'toggle') {
                // Optimistic UI update
                isPlaying = !isPlaying;
                const path = document.getElementById('playPausePath');
                if (path) {
                    path.setAttribute('d', isPlaying ? 'M6 19h4V5H6v14zm8-14v14h4V5h-4z' : 'M8 5v14l11-7z');
                }
                msgData.state = isPlaying ? 'playing' : 'paused';
            }
            syncClient.send('control', msgData);
        }

        function playTrackFromItem(item) {
            lastUserActionTime = Date.now();
            const title = item.dataset.title;
            const vid = item.dataset.videoid;
            const artist = item.dataset.artist;

            const miniPlayer = document.getElementById('miniPlayer');
            miniPlayer.classList.add('active');
            document.getElementById('nowPlayingTitle').textContent = title;
            document.getElementById('nowPlayingArtist').textContent = artist;

            // Update icon optimistically
            isPlaying = true;
            const path = document.getElementById('playPausePath');
            if (path) path.setAttribute('d', 'M6 19h4V5H6v14zm8-14v14h4V5h-4z');

            // Send immediate WebSocket play command (Faster than HTTP)
            syncClient.send('play', { videoId: vid, title: title, timestamp: 0 });

            document.getElementById('queryInput').value = title;
            document.getElementById('videoIdInput').value = vid;
            document.getElementById('nextPlay').checked = true;
            const val = navVolSlider ? navVolSlider.value : (volSlider ? volSlider.value : '{{maxVol}}');
            document.getElementById('maxVol').value = val;
            submitSearch();
        }

        document.getElementById('tracksList').addEventListener('click', (e) => {
            const item = e.target.closest('.track-item');
            if (item && !e.target.closest('.menu-btn')) {
                playTrackFromItem(item);
            }
        });

        function syncVolumeUI(v) {
            if (volSlider) volSlider.value = v;
            if (volProgress) volProgress.style.width = v + '%';
            if (navVolSlider) navVolSlider.value = v;
            if (navVolProgress) navVolProgress.style.height = v + '%';
            if (navVolLabel) navVolLabel.textContent = v + '%';
        }

        function updateAllVolume(v) {
            const vol = parseInt(v);
            if (isNaN(vol)) return;
            syncVolumeUI(vol);
            syncClient.send('vol', { volume: vol });
        }

        // Horizontal Volume Slider Listener
        if (volSlider) {
            volSlider.addEventListener('input', (e) => {
                updateAllVolume(e.target.value);
            });
        }


        let volumeHideTimer = null;
        function resetVolumeTimer() {
            if (volumeHideTimer) clearTimeout(volumeHideTimer);
            volumeHideTimer = setTimeout(() => {
                document.getElementById('navVolumePopover').classList.remove('active');
            }, 3000);
        }

        if (navVolSlider) {
            function handleVertSlide(e) {
                const rect = document.querySelector('.vert-slider-wrapper').getBoundingClientRect();
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                let pct = 1 - (clientY - rect.top) / rect.height;
                pct = Math.max(0, Math.min(100, Math.round(pct * 100)));
                updateAllVolume(pct);
                resetVolumeTimer();
                e.preventDefault();
            }

            // Using the hidden input for native accessibility, but overlaying better events
            const hInput = document.getElementById('navVolSlider');
            hInput.addEventListener('mousedown', (e) => {
                handleVertSlide(e);
                const move = (me) => handleVertSlide(me);
                const up = () => {
                    document.removeEventListener('mousemove', move);
                    document.removeEventListener('mouseup', up);
                };
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', up);
            });

            hInput.addEventListener('touchstart', (e) => {
                handleVertSlide(e);
                const tmove = (te) => handleVertSlide(te);
                const tend = () => {
                    document.removeEventListener('touchmove', tmove);
                    document.removeEventListener('touchend', tend);
                };
                document.addEventListener('touchmove', tmove, { passive: false });
                document.addEventListener('touchend', tend);
            }, { passive: false });

            // Sync the input value for form submission
            hInput.addEventListener('input', (e) => {
                updateAllVolume(e.target.value);
                resetVolumeTimer();
            });
        }

        function toggleVolumePopover(e) {
            e.stopPropagation();
            const popover = document.getElementById('navVolumePopover');
            popover.classList.toggle('active');
            if (popover.classList.contains('active')) resetVolumeTimer();
        }
        document.addEventListener('click', () => {
            document.getElementById('navVolumePopover').classList.remove('active');
            if (volumeHideTimer) clearTimeout(volumeHideTimer);
        });


        let currentSort = 'official';
        function cycleSort() {
            const modes = ['official', 'remix', 'lyrical', 'slowed', 'relevance'];
            currentSort = modes[(modes.indexOf(currentSort) + 1) % modes.length];
            document.getElementById('sortLabel').textContent = currentSort.charAt(0).toUpperCase() + currentSort.slice(1) + ' >';
            sortResults(currentSort);
        }

        function sortResults(criteria) {
            const containers = ['songsContainer', 'videosContainer'];
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (!container) return;
                const items = Array.from(container.querySelectorAll('.track-item'));
                items.sort((a, b) => {
                    const getLabels = (el) => Array.from(el.querySelectorAll('.badge')).map(b => b.textContent.toLowerCase());
                    const la = getLabels(a), lb = getLabels(b);
                    if (criteria === 'official') return lb.includes('official') - la.includes('official');
                    if (criteria === 'remix') return lb.includes('remix') - la.includes('remix');
                    if (criteria === 'lyrical') return lb.includes('lyrical') - la.includes('lyrical');
                    if (criteria === 'slowed') return lb.includes('slowed') - la.includes('slowed');
                    return 0;
                });
                items.forEach(el => container.appendChild(el));
            });
        }

        window.addEventListener('load', () => { if (!queryInput.value) queryInput.focus(); });
    </script>
</body>

</html>